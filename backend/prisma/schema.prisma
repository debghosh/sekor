// Prisma Schema for Sekor-BKC Production
// Multi-content-type support: Articles, Podcasts, Vlogs, Photo Essays
// Enhanced with Creator Portal features

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  READER
  AUTHOR
  EDITOR
  ADMIN
  CREATOR  // Added for creator portal
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum ContentType {
  ARTICLE
  PODCAST
  VLOG
  PHOTO_ESSAY
  VIDEO        // Added
  AUDIO        // Added
  MULTIMEDIA   // Added
}

enum ContentStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
  SUBMITTED           // Added for creator workflow
  IN_REVIEW          // Added
  CHANGES_REQUESTED  // Added
  APPROVED           // Added
  REJECTED           // Added
  SCHEDULED          // Added
}

enum SubscriptionPlan {
  FREE
  PREMIUM
}

enum SubscriptionFrequency {
  DAILY
  WEEKLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAUSED
}

enum EngagementType {
  VIEW
  LIKE
  SHARE
  COMMENT
  SAVE
}

// ===== NEW CREATOR PORTAL ENUMS =====

enum Language {
  BENGALI
  ENGLISH
  BILINGUAL
}

enum Copyright {
  CREATOR
  CC_BY
  CC_BY_SA
  PUBLIC_DOMAIN
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum ReactionType {
  LOVE
  INSIGHTFUL
  NOSTALGIC
  INSPIRING
}

// ============================================================================
// USER MODELS
// ============================================================================

model User {
  id                   String         @id @default(uuid())
  email                String         @unique
  name                 String
  passwordHash         String?        @map("password_hash")
  role                 Role           @default(READER)
  avatarUrl            String?        @map("avatar_url")
  bio                  String?
  emailVerified        Boolean        @default(false) @map("email_verified")
  verificationToken    String?        @unique @map("verification_token")
  resetToken           String?        @unique @map("reset_token")
  resetTokenExpires    DateTime?      @map("reset_token_expires")
  status               UserStatus     @default(ACTIVE)
  lastLogin            DateTime?      @map("last_login")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  // Existing Relations
  content              Content[]
  subscription         Subscription?
  followers            UserFollow[]   @relation("following")
  following            UserFollow[]   @relation("follower")
  savedContent         SavedContent[]
  engagement           ContentEngagement[]
  notifications        Notification[]
  comments             Comment[]

  // NEW Creator Portal Relations
  stories              Story[]              @relation("AuthoredStories")
  coAuthoredStories    Story[]              @relation("CoAuthoredStories")
  reviewedStories      Story[]              @relation("ReviewedStories")
  media                Media[]
  reactions            Reaction[]
  storyComments        StoryComment[]
  creatorAnalytics     CreatorAnalytics?
  receivedSupport      ReaderSupport[]      @relation("CreatorSupport")
  givenSupport         ReaderSupport[]      @relation("SupporterDonations")

  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

model UserFollow {
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

// ============================================================================
// CONTENT MODELS (Existing - Keep as is)
// ============================================================================

model Content {
  id              String        @id @default(uuid())
  type            ContentType   @default(ARTICLE)
  title           String
  slug            String        @unique
  summary         String?       @db.Text
  
  // Common fields for all content types
  categoryId      String        @map("category_id")
  authorId        String        @map("author_id")
  status          ContentStatus @default(DRAFT)
  publishDate     DateTime?     @map("publish_date")
  views           Int           @default(0)
  
  // Type-specific data stored as JSONB
  typeData        Json          @map("type_data")
  
  // SEO fields
  seoTitle        String?       @map("seo_title")
  seoDescription  String?       @map("seo_description")
  seoKeywords     String[]      @map("seo_keywords")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  category        Category              @relation(fields: [categoryId], references: [id])
  author          User                  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  savedBy         SavedContent[]
  engagement      ContentEngagement[]
  tags            ContentTag[]
  comments        Comment[]

  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([type])
  @@index([slug])
  @@index([publishDate])
  @@map("content")
}

// ============================================================================
// NEW STORY MODEL (Creator Portal Enhanced Content)
// ============================================================================

model Story {
  id              String        @id @default(uuid())
  
  // Bilingual content
  title           String
  titleBn         String?       @map("title_bn")
  titleEn         String?       @map("title_en")
  
  abstract        String        @db.Text
  abstractBn      String?       @map("abstract_bn") @db.Text
  abstractEn      String?       @map("abstract_en") @db.Text
  
  body            Json          // Quill Delta format
  bodyBn          Json?         @map("body_bn")
  bodyEn          Json?         @map("body_en")
  
  // Media
  thumbnail       String?
  thumbnailAlt    String?       @map("thumbnail_alt")
  
  // Categorization
  categoryId      String        @map("category_id")
  
  // Publishing
  status          ContentStatus @default(DRAFT)
  publishedAt     DateTime?     @map("published_at")
  scheduledFor    DateTime?     @map("scheduled_for")
  expiryDate      DateTime?     @map("expiry_date")
  
  // Attribution
  authorId        String        @map("author_id")
  
  // Metadata
  slug            String        @unique
  language        Language      @default(BILINGUAL)
  contentType     ContentType   @default(ARTICLE)
  readingTime     Int           @default(0) @map("reading_time") // minutes
  wordCount       Int           @default(0) @map("word_count")
  
  // Rights
  copyright       Copyright     @default(CREATOR)
  allowComments   Boolean       @default(true) @map("allow_comments")
  allowSharing    Boolean       @default(true) @map("allow_sharing")
  isPremium       Boolean       @default(false) @map("is_premium")
  
  // Analytics aggregated
  viewCount       Int           @default(0) @map("view_count")
  uniqueVisitors  Int           @default(0) @map("unique_visitors")
  reactionCount   Int           @default(0) @map("reaction_count")
  commentCount    Int           @default(0) @map("comment_count")
  shareCount      Int           @default(0) @map("share_count")
  bookmarkCount   Int           @default(0) @map("bookmark_count")
  
  // Review
  reviewNotes     String?       @map("review_notes") @db.Text
  reviewerId      String?       @map("reviewer_id")
  reviewedAt      DateTime?     @map("reviewed_at")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  category        Category              @relation(fields: [categoryId], references: [id])
  author          User                  @relation("AuthoredStories", fields: [authorId], references: [id], onDelete: Cascade)
  reviewer        User?                 @relation("ReviewedStories", fields: [reviewerId], references: [id])
  coAuthors       User[]                @relation("CoAuthoredStories")
  tags            StoryTag[]
  locations       Location[]
  media           StoryMedia[]
  analytics       StoryAnalytics[]
  reactions       Reaction[]
  comments        StoryComment[]
  sources         Source[]

  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([slug])
  @@index([publishedAt])
  @@index([reviewerId])
  @@map("stories")
}

// ============================================================================
// CATEGORY & TAG MODELS (Existing)
// ============================================================================

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  nameBengali String?   @map("name_bengali")
  description String?   @db.Text
  parentId    String?   @map("parent_id")
  order       Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  content     Content[]
  stories     Story[]    // NEW

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Tag {
  id        String       @id @default(uuid())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now()) @map("created_at")

  // Relations
  content   ContentTag[]
  stories   StoryTag[]   // NEW

  @@index([slug])
  @@map("tags")
}

model ContentTag {
  contentId String  @map("content_id")
  tagId     String  @map("tag_id")

  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contentId, tagId])
  @@index([contentId])
  @@index([tagId])
  @@map("content_tags")
}

// NEW: Story tags
model StoryTag {
  storyId   String  @map("story_id")
  tagId     String  @map("tag_id")

  story     Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([storyId, tagId])
  @@index([storyId])
  @@index([tagId])
  @@map("story_tags")
}

// ============================================================================
// NEW CREATOR PORTAL MODELS
// ============================================================================

// Media files
model Media {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  
  filename        String
  originalName    String        @map("original_name")
  mimeType        String        @map("mime_type")
  size            Int           // bytes
  type            MediaType
  url             String
  thumbnailUrl    String?       @map("thumbnail_url")
  
  // Cloud storage
  storageProvider String?       @map("storage_provider")
  storageKey      String?       @map("storage_key")
  
  // Metadata
  altText         String?       @map("alt_text")
  caption         String?       @db.Text
  credit          String?
  
  // Dimensions
  width           Int?
  height          Int?
  duration        Int?          // seconds for video/audio
  
  // Usage tracking
  usageCount      Int           @default(0) @map("usage_count")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  stories         StoryMedia[]

  @@index([userId])
  @@index([type])
  @@map("media")
}

// Story-Media junction
model StoryMedia {
  id        String   @id @default(uuid())
  storyId   String   @map("story_id")
  mediaId   String   @map("media_id")
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  media     Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([storyId, mediaId])
  @@index([storyId])
  @@index([mediaId])
  @@map("story_media")
}

// Location tagging
model Location {
  id           String   @id @default(uuid())
  name         String
  nameBn       String   @map("name_bn")
  coordinates  Json?    // { lat, lng }
  area         String?
  isHistorical Boolean  @default(false) @map("is_historical")
  description  String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  stories      Story[]

  @@unique([name, area])
  @@index([area])
  @@map("locations")
}

// Story analytics (daily snapshots)
model StoryAnalytics {
  id              String   @id @default(uuid())
  storyId         String   @map("story_id")
  date            DateTime @db.Date
  
  // Views
  views           Int      @default(0)
  uniqueVisitors  Int      @default(0) @map("unique_visitors")
  avgTimeOnPage   Int      @default(0) @map("avg_time_on_page") // seconds
  completionRate  Float    @default(0) @map("completion_rate")
  bounceRate      Float    @default(0) @map("bounce_rate")
  avgScrollDepth  Float    @default(0) @map("avg_scroll_depth")
  
  // Interactions
  reactions       Json     @default("{}") // { love: 0, insightful: 0, etc }
  comments        Int      @default(0)
  shares          Json     @default("{}") // { facebook: 0, twitter: 0, etc }
  bookmarks       Int      @default(0)
  
  // Demographics
  topLocations    Json     @default("[]") @map("top_locations")
  devices         Json     @default("{}")
  referrals       Json     @default("{}")
  languages       Json     @default("{}")
  
  createdAt       DateTime @default(now()) @map("created_at")

  story           Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, date])
  @@index([storyId])
  @@index([date])
  @@map("story_analytics")
}

// Creator analytics
model CreatorAnalytics {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  date               DateTime @db.Date
  
  totalStories       Int      @default(0) @map("total_stories")
  publishedStories   Int      @default(0) @map("published_stories")
  totalViews         Int      @default(0) @map("total_views")
  totalReactions     Int      @default(0) @map("total_reactions")
  totalComments      Int      @default(0) @map("total_comments")
  totalShares        Int      @default(0) @map("total_shares")
  
  followers          Int      @default(0)
  followerGrowth     Int      @default(0) @map("follower_growth")
  
  earnings           Float    @default(0)
  supportCount       Int      @default(0) @map("support_count")
  avgSupport         Float    @default(0) @map("avg_support")
  
  avgEngagementRate  Float    @default(0) @map("avg_engagement_rate")
  avgCompletionRate  Float    @default(0) @map("avg_completion_rate")
  
  createdAt          DateTime @default(now()) @map("created_at")

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("creator_analytics")
}

// Reactions
model Reaction {
  id        String       @id @default(uuid())
  storyId   String       @map("story_id")
  userId    String?      @map("user_id")
  type      ReactionType
  createdAt DateTime     @default(now()) @map("created_at")

  story     Story        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([storyId, userId, type])
  @@index([storyId])
  @@index([userId])
  @@map("reactions")
}

// Story comments
model StoryComment {
  id         String         @id @default(uuid())
  storyId    String         @map("story_id")
  userId     String?        @map("user_id")
  content    String         @db.Text
  isApproved Boolean        @default(false) @map("is_approved")
  isPinned   Boolean        @default(false) @map("is_pinned")
  parentId   String?        @map("parent_id")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  story      Story          @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user       User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  parent     StoryComment?  @relation("StoryCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    StoryComment[] @relation("StoryCommentReplies")

  @@index([storyId])
  @@index([userId])
  @@index([parentId])
  @@map("story_comments")
}

// Sources/Citations
model Source {
  id           String    @id @default(uuid())
  storyId      String    @map("story_id")
  type         String
  title        String
  author       String?
  url          String?
  dateAccessed DateTime? @map("date_accessed")
  notes        String?   @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")

  story        Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@map("sources")
}

// Reader support/donations
model ReaderSupport {
  id            String   @id @default(uuid())
  storyId       String?  @map("story_id")
  creatorId     String   @map("creator_id")
  supporterId   String?  @map("supporter_id")
  
  amount        Float
  currency      String   @default("INR")
  message       String?  @db.Text
  isAnonymous   Boolean  @default(false) @map("is_anonymous")
  
  paymentId     String?  @unique @map("payment_id")
  paymentStatus String   @default("pending") @map("payment_status")
  paymentMethod String?  @map("payment_method")
  
  createdAt     DateTime @default(now()) @map("created_at")

  creator       User     @relation("CreatorSupport", fields: [creatorId], references: [id], onDelete: Cascade)
  supporter     User?    @relation("SupporterDonations", fields: [supporterId], references: [id], onDelete: SetNull)

  @@index([creatorId])
  @@index([supporterId])
  @@index([storyId])
  @@map("reader_support")
}

// ============================================================================
// ENGAGEMENT MODELS (Existing - Keep as is)
// ============================================================================

model SavedContent {
  userId    String   @map("user_id")
  contentId String   @map("content_id")
  tags      String[]
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@id([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@map("saved_content")
}

model ContentEngagement {
  id             String         @id @default(uuid())
  contentId      String         @map("content_id")
  userId         String?        @map("user_id")
  engagementType EngagementType @map("engagement_type")
  metadata       Json?
  createdAt      DateTime       @default(now()) @map("created_at")

  content        Content        @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([contentId])
  @@index([userId])
  @@index([engagementType])
  @@index([createdAt])
  @@map("content_engagement")
}

model Comment {
  id        String   @id @default(uuid())
  contentId String   @map("content_id")
  userId    String   @map("user_id")
  parentId  String?  @map("parent_id")
  text      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  content   Content   @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@index([contentId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comments")
}

// ============================================================================
// SUBSCRIPTION MODELS (Existing - Keep as is)
// ============================================================================

model Subscription {
  id                    String               @id @default(uuid())
  userId                String               @unique @map("user_id")
  plan                  SubscriptionPlan     @default(FREE)
  frequency             SubscriptionFrequency?
  interests             String[]
  stripeCustomerId      String?              @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?              @unique @map("stripe_subscription_id")
  status                SubscriptionStatus   @default(ACTIVE)
  currentPeriodStart    DateTime?            @map("current_period_start")
  currentPeriodEnd      DateTime?            @map("current_period_end")
  cancelAt              DateTime?            @map("cancel_at")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")

  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
  @@map("subscriptions")
}

// ============================================================================
// NOTIFICATION MODELS (Existing - Keep as is)
// ============================================================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}
